document.addEventListener('DOMContentLoaded', function() {
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }
    });
</script>
<div class="container" style="max-width: 900px !important; width: 900px !important; margin: 0 auto !important; padding: 30px !important; border-radius: 8px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;">
    <!-- User Account Section -->
    <div class="user-account">
        <span class="user-email" id="user-email"></span>
        <button type="button" class="logout-button" id="logout-button">Logout</button>
    </div>

    <h1>Create Your Star Map</h1>
    <form id="customizationForm" onsubmit="event.preventDefault();">

        <!-- Section 1: Event Details -->
        <fieldset class="form-section" id="event-details-fieldset">
            <legend>Event Details</legend>
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px 25px; justify-content: center;">
                <div class="input-group" style="margin-bottom: 0; flex-grow: 0; width: auto;">
                    <label for="occasion">Event/Occasion:</label>
                    <select id="occasion" name="occasion" style="width: 400px; min-width: 350px;"> <!-- USER ADJUSTED Width -->
                        <option value="">Select an option</option>
                        <option value="custom">Add Your Own...</option>
                        <option value="mothers_day">Mother's Day</option>
                        <option value="fathers_day">Father's Day</option>
                        <option value="birthday">Birthday</option>
                        <option value="day_we_met">Day We Met</option>
                        <option value="our_anniversary">Our Wedding Day</option>
                        <option value="engagement_day">Day We Were Engaged</option>
                        <option value="sweet_16_birthday">Sweet 16 Birthday</option>
                        <option value="21st_birthday">21st Birthday</option>
                        <option value="graduation_day">Graduation Day</option>
                        <option value="retirement">Finally Retired</option>
                    </select>
                    <input type="text" id="custom-occasion" placeholder="Enter Custom Occasion" style="display: none; flex-grow: 2;">
                </div>
                <script>
                    // Time Display Toggle Functionality
                    document.addEventListener('DOMContentLoaded', function() {
                        const showTimeToggle = document.getElementById('show-time-toggle');
                        
                        // Initialize the toggle state from localStorage or default to true
                        const showTimeInStarMap = localStorage.getItem('showTimeInStarMap') !== 'false';
                        showTimeToggle.checked = showTimeInStarMap;
                        
                        // Update the toggle state when changed
                        showTimeToggle.addEventListener('change', function() {
                            localStorage.setItem('showTimeInStarMap', this.checked);
                            updateDateTimeDisplay();
                        });
                        
                        // Function to update the date/time display in the preview
                        function updateDateTimeDisplay() {
                            // This will be called when generating the star map
                            const dateInput = document.getElementById('date');
                            const timeInput = document.getElementById('time');
                            const showTime = showTimeToggle.checked;
                            
                            // Update the date display in the text placement section
                            const dateDisplaySpan = document.getElementById('text-placement-content-date');
                            if (dateDisplaySpan) {
                                const dateValue = dateInput.value;
                                const timeValue = timeInput.value;
                                
                                if (dateValue) {
                                    const formattedDate = new Date(dateValue).toLocaleDateString('en-US', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    });
                                    
                                    if (showTime && timeValue) {
                                        // Format time in 12-hour format
                                        const timeParts = timeValue.split(':');
                                        let hours = parseInt(timeParts[0]);
                                        const minutes = timeParts[1];
                                        const ampm = hours >= 12 ? 'PM' : 'AM';
                                        hours = hours % 12;
                                        hours = hours ? hours : 12; // Convert 0 to 12
                                        const formattedTime = `${hours}:${minutes} ${ampm}`;
                                        
                                        dateDisplaySpan.textContent = `${formattedDate}, ${formattedTime}`;
                                    } else {
                                        dateDisplaySpan.textContent = formattedDate;
                                    }
                                } else {
                                    dateDisplaySpan.textContent = '';
                                }
                            }
                        }
                        
                        // Add event listeners to update the display when date or time changes
                        const dateInput = document.getElementById('date');
                        const timeInput = document.getElementById('time');
                        
                        if (dateInput) {
                            dateInput.addEventListener('change', updateDateTimeDisplay);
                        }
                        
                        if (timeInput) {
                            timeInput.addEventListener('change', updateDateTimeDisplay);
                        }
                        
                        // Initial update
                        updateDateTimeDisplay();
                    });
                    </script>
                
<!-- 2. Replace the time input in the Event Details section with this code -->
<div class="input-group" style="margin-bottom: 0; flex-grow: 0; width: auto;">
    <label for="date">Date/Time:</label>
    <input type="date" id="date" required style="width: 110px; min-width: 110px;">
    <input type="time" id="time" required style="width: 100px; min-width: 100px;">
    
    <!-- Time Display Toggle -->
    <div class="time-toggle-container">
        <label class="time-toggle-label">
            <span class="time-toggle-tooltip">Show/hide time on star map</span>
            <i class="fas fa-clock time-toggle-icon"></i>
            <span class="time-toggle-switch">
                <input type="checkbox" id="show-time-toggle" checked>
                <span class="time-toggle-slider"></span>
            </span>
        </label>
    </div>
</div>
            </div>
        </fieldset>

        <!-- Section 2: Map Location -->
        <fieldset class="form-section">
            <legend>Map Location</legend>
             <div id="map-container">
                 <div id="map"></div>
                 <div id="crosshairs"></div>
             </div>
             <p id="latLongDisplay" style="font-weight: bold; font-size: 1.1em; color: #ff0000;">Lat: ... | Long: ...</p>
             <div class="manual-coordinates">
                 <div class="input-group"> <!-- Lat -->
                    <label for="latitude">Latitude:</label>
                    <input type="text" id="latitude" placeholder="e.g., N32° 56.88113" required style="color: #0056b3;">
                 </div>
                 <div class="input-group"> <!-- Lng -->
                    <label for="longitude">Longitude:</label>
                    <input type="text" id="longitude" placeholder="e.g., W80° 7.22460" required style="color: #0056b3;">
                 </div>
                 <div class="input-group"> <!-- Zip -->
                    <label for="zip-code">Zip/Postal:</label>
                    <input type="text" id="zip-code" placeholder="Enter Code" style="color: #0056b3;"> <!-- REMOVED list attribute -->
                    <!-- ADDED suggestions container -->
                     <div id="zip-suggestions" class="history-suggestions" style="display: none;">
                  </div>
               </div>
            </div>
            <div class="input-group" style="display: flex; flex-direction: row; align-items: center; margin-top: 10px; position: relative;">
                <label for="address" style="min-width: 80px; text-align: right; margin-right: 5px;">By Address:</label>
                <input type="text" id="address" placeholder="Enter street address, city, state/province, country" style="color: #0056b3; font-weight: 600; font-size: 16px;">
                <!-- ADDED suggestions container for address history -->
                <div id="address-suggestions" class="history-suggestions" style="display: none; left: 90px;">
            </div>
            </div>

            </div>
        </fieldset>


        <!-- Section 3: Customizable Text Layers + Fixed Layers (COMBINED) -->
        <fieldset class="form-section" id="customizable-text-fieldset">
            <legend>Customizable Text Layers + Fixed Layers</legend>
            <div id="text-layer-container">
                <!-- Text Layer 1 -->
                <div class="text-entry-wrapper">
                    <label for="text-entry-1">#1</label> <!-- MODIFIED LABEL -->
                    <input type="text" class="text-entry" id="text-entry-1" placeholder="Main Title" maxlength="50" required>
                    <!-- MOVED char-count span -->
                    <span class="char-count" id="char-count-1">50</span>
                    <div class="font-controls">
                        <select id="font-family-1" class="font-family-select"></select>
                        <select id="font-size-1" class="font-size-select"></select>
                        <!-- REMOVED char-count span from here -->
                        <div class="style-options">
                            <label><input type="checkbox" id="text-bold-1"> Bold</label>
                            <label><input type="checkbox" id="text-italic-1"> Italic</label>
                        </div>
                        <input type="text" id="font-color-1" value="#FFFFFF" style="display:none;">
                        <button type="button" class="color-swatch" data-target="font-color-1" aria-label="Font Color 1"></button>
                    </div>
                     <!-- ADDED suggestions container -->
                    <div id="text-entry-1-suggestions" class="history-suggestions" style="display: none;"></div>
                </div>
                <!-- Text Layer 2 -->
                 <div class="text-entry-wrapper">
                     <label for="text-entry-2">#2</label> <!-- MODIFIED LABEL -->
                     <input type="text" class="text-entry" id="text-entry-2" placeholder="Subtitle" maxlength="50" required>
                     <!-- MOVED char-count span -->
                     <span class="char-count" id="char-count-2">50</span>
                     <div class="font-controls">
                         <select id="font-family-2" class="font-family-select"></select>
                         <select id="font-size-2" class="font-size-select"></select>
                         <!-- REMOVED char-count span from here -->
                         <div class="style-options">
                             <label><input type="checkbox" id="text-bold-2"> Bold</label>
                             <label><input type="checkbox" id="text-italic-2"> Italic</label>
                         </div>
                         <input type="text" id="font-color-2" value="#FFFFFF" style="display:none;">
                         <button type="button" class="color-swatch" data-target="font-color-2" aria-label="Font Color 2"></button>
                     </div>
                      <!-- ADDED suggestions container -->
                     <div id="text-entry-2-suggestions" class="history-suggestions" style="display: none;"></div>
                 </div>
                <!-- Text Layer 3 -->
                 <div class="text-entry-wrapper">
                     <label for="text-entry-3">#3</label> <!-- MODIFIED LABEL -->
                     <input type="text" class="text-entry" id="text-entry-3" placeholder="Additional text" maxlength="50" required>
                     <!-- MOVED char-count span -->
                     <span class="char-count" id="char-count-3">50</span>
                     <div class="font-controls">
                         <select id="font-family-3" class="font-family-select"></select>
                         <select id="font-size-3" class="font-size-select"></select>
                         <!-- REMOVED char-count span from here -->
                         <div class="style-options">
                             <label><input type="checkbox" id="text-bold-3"> Bold</label>
                             <label><input type="checkbox" id="text-italic-3"> Italic</label>
                         </div>
                         <input type="text" id="font-color-3" value="#FFFFFF" style="display:none;">
                         <button type="button" class="color-swatch" data-target="font-color-3" aria-label="Font Color 3"></button>
                     </div>
                      <!-- ADDED suggestions container -->
                     <div id="text-entry-3-suggestions" class="history-suggestions" style="display: none;"></div>
                 </div>
                 <!-- Text Layer 4 (Place Name) - ADDED for Task M -->
                 <div class="text-entry-wrapper">
                     <label for="text-entry-4">#4</label>
                     <input type="text" class="text-entry" id="text-entry-4" placeholder="Enter City/Town/event site, State/County, Country etc" maxlength="50">
                     <span class="char-count" id="char-count-4">50</span>
                     <div class="font-controls">
                         <select id="font-family-4" class="font-family-select"></select>
                         <select id="font-size-4" class="font-size-select"></select>
                         <div class="style-options">
                             <label><input type="checkbox" id="text-bold-4"> Bold</label>
                             <label><input type="checkbox" id="text-italic-4"> Italic</label>
                         </div>
                         <input type="text" id="font-color-4" value="#FFFFFF" style="display:none;">
                         <button type="button" class="color-swatch" data-target="font-color-4" aria-label="Font Color 4"></button>
                     </div>
                     <div id="text-entry-4-suggestions" class="history-suggestions" style="display: none;"></div>
                 </div>
            </div>
            
            <!-- Fixed Text Content (moved from Fixed Text Styling section) -->
            <hr>
            <div class="fixed-text-content">
                <div class="input-group">
                    <label>Date Text:</label>
                    <select id="fixed-font-family-date" class="font-family-select"></select>
                    <select id="fixed-font-size-date" class="font-size-select"></select>
                    <div class="style-options">
                        <label><input type="checkbox" id="fixed-text-bold-date"> Bold</label>
                        <label><input type="checkbox" id="fixed-text-italic-date"> Italic</label>
                    </div>
                    <input type="text" id="fixed-font-color-date" value="#FFFFFF" style="display:none;">
                    <button type="button" class="color-swatch" data-target="fixed-font-color-date" aria-label="Fixed Date Font Color"></button>
                </div>
                <div class="input-group">
                    <label>Coordinates Text:</label>
                    <select id="fixed-font-family-coords" class="font-family-select"></select>
                    <select id="fixed-font-size-coords" class="font-size-select"></select>
                    <div class="style-options">
                        <label><input type="checkbox" id="fixed-text-bold-coords"> Bold</label>
                        <label><input type="checkbox" id="fixed-text-italic-coords"> Italic</label>
                    </div>
                    <input type="text" id="fixed-font-color-coords" value="#FFFFFF" style="display:none;">
                    <button type="button" class="color-swatch" data-target="fixed-font-color-coords" aria-label="Fixed Coordinates Font Color"></button>
                </div>
                <!-- Place Text row removed as it's redundant with Text Entry #4 -->
            </div>
        </fieldset>

        <!-- Section 5: Star Map Canvas + Image Settings (COMBINED) -->
        <fieldset class="form-section" id="canvas-settings">
            <legend>Star Map Canvas + Image Settings</legend>
            <div class="settings-row"> <!-- Row 1 -->
                <label for="paper-auto-size">Paper Auto-Size:</label>
                <select id="paper-auto-size">
                    <option value="">Select A Paper Size...</option>
                    <option value="letter">Letter (8.5" x 11")</option>
                    <option value="legal">Legal (8.5" x 14")</option>
                    <option value="tabloid">Tabloid (11" x 17")</option>
                    <option value="a4">A4 (210mm x 297mm)</option>
                    <option value="a3">A3 (297mm x 420mm)</option>
                    <option value="a2">A2 (420mm x 594mm)</option>
                    <option value="a1">A1 (594mm x 841mm)</option>
                    <option value="a0">A0 (841mm x 1189mm)</option>
                    <option value="4x6">4" x 6" Photo</option>
                    <option value="5x7">5" x 7" Photo</option>
                    <option value="8x10">8" x 10" Photo</option>
                    <option value="11x14">11" x 14" Photo</option>
                    <option value="16x20">16" x 20" Photo</option>
                    <option value="20x30">20" x 30" Photo</option>
                    <option value="24x36">24" x 36" Poster</option>
                    <option value="custom">Custom Size</option>
                </select>
                
                <label for="dpi-selector">DPI:</label>
                <select id="dpi-selector">
                    <option value="72">72 (Web)</option>
                    <option value="150">150 (Draft)</option>
                    <option value="300" selected>300 (Print)</option>
                    <option value="600">600 (High)</option>
                </select>
            </div>
            
            <div class="settings-row"> <!-- Row 2 -->
                <label for="output-width">Width (px):</label>
                <input type="number" id="output-width" value="2550" min="100">
                <label for="output-height">Height (px):</label>
                <input type="number" id="output-height" value="3300" min="100">
                <label for="maintain-aspect-ratio"><input type="checkbox" id="maintain-aspect-ratio" checked> Aspect Ratio</label>
                <label for="bg-color-canvas">Canvas Bg:</label>
                <input type="text" id="bg-color-canvas" value="#000033" style="display:none;">
                <button type="button" class="color-swatch" data-target="bg-color-canvas" aria-label="Star Map Canvas Background Color"></button>
            </div>

            <!-- Star Map Image Settings (moved from separate section) -->
            <hr>
            <div class="image-settings-content">
                <h3>Star Map Image Settings</h3>
                <div class="settings-row">
                    <label for="star-map-style">Star Map Style:</label>
                    <select id="star-map-style">
                        <option value="default" selected>Default</option>
                        <option value="inverted">Inverted</option>
                        <option value="navy">Navy</option>
                        <option value="red">Red</option>
                    </select>
                    <label for="circle-radius-percent">Circle Radius %:</label>
                    <input type="number" id="circle-radius-percent" value="60" min="10" max="100" step="1"> <!-- Default changed to 60 -->
                    <label for="border-width">Border Width (px):</label>
                    <input type="number" id="border-width" value="1" min="0" step="1">
                    <label for="border-color">Border Color:</label>
                    <input type="text" id="border-color" value="#FFFFFF" style="display:none;">
                    <button type="button" class="color-swatch" data-target="border-color" aria-label="Circle Border Color"></button>
                    <!-- Re-add Advanced Options toggle here -->
                    <button type="button" id="advanced-options-toggle">Advanced Options <i class="fas fa-chevron-down"></i></button>
                </div>
            </div>

            <!-- Advanced Options Panel (Keep separate, but button moved to image settings) -->
            <div id="advanced-options-panel">
                <div class="section-title">Advanced Star Map Options</div>
                <div class="advanced-options-grid">
                    <fieldset class="advanced-options-quadrant">
                        <legend>Features</legend>
                        <label><input type="checkbox" id="adv-show-milky-way" data-api-param="showMilkyWay" checked> Milky Way</label>
                        <label><input type="checkbox" id="adv-show-constellation-lines" data-api-param="showConstellationLines" checked> Constellation Lines</label>
                        <label><input type="checkbox" id="adv-show-stars-glow" data-api-param="showStarsGlow"> Stars Glow</label>
                    </fieldset>
                    <fieldset class="advanced-options-quadrant">
                        <legend>Celestial Bodies</legend>
                        <label><input type="checkbox" id="adv-show-moon" data-api-param="showMoon"> Moon</label>
                        <label><input type="checkbox" id="adv-show-sun" data-api-param="showSun"> Sun</label>
                        <label><input type="checkbox" id="adv-show-planets" data-api-param="showPlanets" checked> Planets</label>
                        <label><input type="checkbox" id="adv-show-ecliptic-path" data-api-param="showEclipticPath"> Ecliptic Path</label>
                    </fieldset>
                    <fieldset class="advanced-options-quadrant">
                        <legend>Labels</legend>
                        <label><input type="checkbox" id="adv-show-planet-labels" data-api-param="showPlanetLabels" checked> Planet Labels</label>
                        <label><input type="checkbox" id="adv-show-constellation-labels" data-api-param="showConstellationLabels"> Constellation Labels</label>
                    </fieldset>
                    <fieldset class="advanced-options-quadrant">
                        <legend>Star Settings</legend>
                        <label for="adv-star-size">Star Size: <span id="adv-star-size-value">1.0</span></label>
                        <input type="range" id="adv-star-size" data-api-param="starSize" min="0.1" max="5" step="0.1" value="1.0">
                        <label for="adv-star-number">Star Number: <span id="adv-star-number-value">2000</span></label>
                        <input type="range" id="adv-star-number" data-api-param="starNumber" min="500" max="10000" step="100" value="2000">
                        <label for="adv-const-line-width">Const. Line Width: <span id="adv-const-line-width-value">1.0</span></label>
                        <input type="range" id="adv-const-line-width" data-api-param="constellationLineWidth" min="0.1" max="3" step="0.1" value="1.0">
                    </fieldset>
                </div>
                <div class="advanced-options-buttons">
                    <button type="button" id="apply-advanced-options" class="apply-button">Apply & Close</button>
                    <button type="button" id="cancel-advanced-options" class="cancel-button">Cancel</button>
                </div>
            </div>
            
            <!-- Text Placements Section -->
            <div class="text-placement-section">
                <div class="text-placement-title">Text Placements On Canvas <i class="fas fa-info-circle info-icon" title="Note: Select a unique Order (First-Sixth) for each item to avoid overlap on the canvas."></i></div> <!-- MODIFIED tooltip text -->
                <div class="text-placement-grid">
                    <!-- Headers -->
                    <div></div> <!-- Empty corner -->
                    <div class="text-placement-header">Text Content</div>
                    <div class="text-placement-header">Order <i class="fas fa-info-circle info-icon" title="Note: Select a unique Order (First-Sixth) for each item to avoid overlap on the canvas."></i></div> <!-- MODIFIED tooltip text -->
                    <div class="text-placement-header">Above Map</div>
                    <div class="text-placement-header">Below Map</div>

                    <!-- Entry 1 -->
                    <label for="text-placement-order-1">Entry#1</label>
                    <span id="text-placement-content-1"></span> <!-- JS will populate this -->
                    <select id="text-placement-order-1" name="text-placement-order-1">
                        <option value="1">First</option><option value="2">Second</option><option value="3">Third</option><option value="4">Fourth</option><option value="5">Fifth</option><option value="6">Sixth</option> <!-- Added Sixth -->
                    </select>
                    <input type="radio" id="text-placement-pos-1-above" name="text-placement-pos-1" value="above">
                    <input type="radio" id="text-placement-pos-1-below" name="text-placement-pos-1" value="below" checked>

                    <!-- Entry 2 -->
                    <label for="text-placement-order-2">Entry#2</label>
                    <span id="text-placement-content-2"></span>
                    <select id="text-placement-order-2" name="text-placement-order-2">
                        <option value="1">First</option><option value="2" selected>Second</option><option value="3">Third</option><option value="4">Fourth</option><option value="5">Fifth</option><option value="6">Sixth</option> <!-- Added Sixth -->
                    </select>
                    <input type="radio" id="text-placement-pos-2-above" name="text-placement-pos-2" value="above">
                    <input type="radio" id="text-placement-pos-2-below" name="text-placement-pos-2" value="below" checked>

                    <!-- Entry 3 -->
                    <label for="text-placement-order-3">Entry#3</label>
                    <span id="text-placement-content-3"></span>
                    <select id="text-placement-order-3" name="text-placement-order-3">
                        <option value="1">First</option><option value="2">Second</option><option value="3" selected>Third</option><option value="4">Fourth</option><option value="5">Fifth</option><option value="6">Sixth</option> <!-- Added Sixth -->
                    </select>
                    <input type="radio" id="text-placement-pos-3-above" name="text-placement-pos-3" value="above">
                    <input type="radio" id="text-placement-pos-3-below" name="text-placement-pos-3" value="below" checked>

                    <!-- Entry 4 (Place Name) - ADDED for Task M -->
                    <label for="text-placement-order-4">Entry#4</label>
                    <span id="text-placement-content-4"></span> <!-- JS will populate this -->
                    <select id="text-placement-order-4" name="text-placement-order-4">
                        <option value="1">First</option><option value="2">Second</option><option value="3">Third</option><option value="4" selected>Fourth</option><option value="5">Fifth</option><option value="6">Sixth</option> <!-- Added Sixth -->
                    </select>
                    <input type="radio" id="text-placement-pos-4-above" name="text-placement-pos-4" value="above">
                    <input type="radio" id="text-placement-pos-4-below" name="text-placement-pos-4" value="below" checked>

                    <!-- Date -->
                    <label for="text-placement-order-date">Date</label>
                    <span id="text-placement-content-date"></span>
                    <select id="text-placement-order-date" name="text-placement-order-date">
                        <option value="1">First</option><option value="2">Second</option><option value="3">Third</option><option value="4">Fourth</option><option value="5" selected>Fifth</option><option value="6">Sixth</option> <!-- Added Sixth -->
                    </select>
                    <input type="radio" id="text-placement-pos-date-above" name="text-placement-pos-date" value="above">
                    <input type="radio" id="text-placement-pos-date-below" name="text-placement-pos-date" value="below" checked>

                    <!-- Coordinates -->
                    <label for="text-placement-order-coords">Coordinates</label>
                    <span id="text-placement-content-coords"></span>
                    <select id="text-placement-order-coords" name="text-placement-order-coords">
                        <option value="1">First</option><option value="2">Second</option><option value="3">Third</option><option value="4">Fourth</option><option value="5">Fifth</option><option value="6" selected>Sixth</option> <!-- Added Sixth, default to 6th -->
                    </select>
                    <input type="radio" id="text-placement-pos-coords-above" name="text-placement-pos-coords" value="above">
                    <input type="radio" id="text-placement-pos-coords-below" name="text-placement-pos-coords" value="below" checked>
                </div>
            </div>
        </fieldset>
